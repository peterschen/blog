{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.2.0.0",
    "parameters": {
        "ResourcePrefix": {
            "type": "string",
            "defaultValue": "DCE",
            "metadata": {
                "Description": "Prefix that is added to top-level resources"
            }
        },
        "VmSize": {
            "type": "string",
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "The size of the Virtual Machine."
            }
        },
        "AdminUsername": {
            "type": "string"
        },
        "AdminPassword": {
            "type": "securestring"
        },
        "AdminSshKey": {
            "type": "securestring",
            "metadata": {
                "description": "RSA key to be configured on all nodes for direct access through ssh."
            }
        },
        "WorkspaceResourceGroup": {
            "type": "string",
            "defaultValue": "dce",
            "metadata": {
                "Description": "Resource group where the Log Analytics workspace was created."
            }
        },
        "WorkspaceName": {
            "type": "string",
            "defaultValue": "DCE-workspace",
            "metadata": {
                "Description": "Name of the Log Analytics workspace."
            }
        },
        "DscConfigurationVersion": {
            "type": "string",
            "defaultValue": "1.0"
        },
        "Office365Account": {
            "type": "string",
            "metadata": {
                "Description": "Office 365 account used in Playbooks for Azure Security Center"
            }
        },
        "MailAddress": {
            "type": "string",
            "metadata": {
                "Description": "Address where mails generated by the Playbooks for Azure Security should be sent to"
            }
        },
        "VmAutoShutdown": {
            "type": "bool",
            "defaultValue": true,
            "metadata": {
                "Description": "Indicates whether the VMs should be automatically turned off at night."
            }
        }
    },
    "variables": {
        "gitBranch": "master",
        "nameSample": "automation-in-azure",
        "urlBase": "[concat('https://raw.githubusercontent.com/peterschen/blog/', variables('gitBranch'), '/')]",
        "urlTemplates": "[concat(variables('urlBase'), '/azure/templates')]",
        "urlSamples": "[concat(variables('urlBase'), '/azure/samples/', variables('nameSample'))]",
        "urlDsc": "[concat(variables('urlSamples'), '/DCE.ps1.zip')]",
        "urlCustomScriptAttacker": "[concat(variables('urlSamples'), '/cs-attacker.sh')]",
        "urlCustomScriptVictim": "[concat(variables('urlSamples'), '/cs-victim.sh')]",
        "nameDeployment": "[deployment().name]",
        "nameDeploymentVmAttacker": "[concat(variables('nameDeployment'), '-AttackerVm')]",
        "nameDeploymentVmAttacker1": "[concat(variables('nameDeploymentVmAttacker'), '1')]",        
        "nameDeploymentVmAttacker2": "[concat(variables('nameDeploymentVmAttacker'), '2')]",        
        "nameDeploymentVmVictim": "[concat(variables('nameDeployment'), '-VictimVm')]",
        "nameDeploymentVmVictim1": "[concat(variables('nameDeploymentVmVictim'), '1')]",
        "nameDeploymentVmVictim2": "[concat(variables('nameDeploymentVmVictim'), '2')]",
        "nameDeploymentLogicApp": "[concat(variables('nameDeployment'), '-LogicApp')]",
        "nameVmAttacker": "attacker",
        "nameVmAttacker1": "[concat(variables('nameVmAttacker'), '1')]",
        "nameVmAttacker2": "[concat(variables('nameVmAttacker'), '2')]",
        "nameVmVictim": "victim",
        "nameVmVictim1": "[concat(variables('nameVmVictim'), '1')]",
        "nameVmVictim2": "[concat(variables('nameVmVictim'), '2')]",
        "nameVnet": "[concat(parameters('ResourcePrefix'), '-vnet')]",
        "idWorkspace": "[concat(subscription().id, '/resourceGroups/', parameters('WorkspaceResourceGroup'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('WorkspaceName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "name": "[variables('nameDeploymentVmAttacker1')]",
            "apiVersion": "2018-05-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('urlTemplates'), '/vm/kali-linux.json')]"
                },
                "parameters": {
                    "Name": {
                        "value": "[variables('nameVmAttacker1')]"
                    },
                    "Region": {
                        "value": "[resourceGroup().location]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('AdminUsername')]"
                    },
                    "AdminPassword": {
                        "value": "[parameters('AdminPassword')]"
                    },
                    "AdminSshKey": {
                        "value": "[parameters('AdminSshKey')]"
                    },
                    "VmSize": {
                        "value": "[parameters('VmSize')]"
                    },
                    "VnetName": {
                        "value": "[variables('nameVnet')]"
                    },
                    "PasswordAuthenticationDisabled": {
                        "value": true
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "[variables('nameDeploymentVmVictim1')]",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('urlTemplates'), '/vm/ubuntu-16.04.json')]"
                },
                "parameters": {
                    "Name": {
                        "value": "[variables('nameVmVictim1')]"
                    },
                    "Region": {
                        "value": "[resourceGroup().location]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('AdminUsername')]"
                    },
                    "AdminPassword": {
                        "value": "[parameters('AdminPassword')]"
                    },
                    "AdminSshKey": {
                        "value": "[parameters('AdminSshKey')]"
                    },
                    "VmSize": {
                        "value": "[parameters('VmSize')]"
                    },
                    "VnetName": {
                        "value": "[variables('nameVnet')]"
                    },
                    "PasswordAuthenticationDisabled": {
                        "value": false
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "[variables('nameDeploymentVmAttacker2')]",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('urlTemplates'), '/vm/windows-2012R2.json')]"
                },
                "parameters": {
                    "Name": {
                        "value": "[variables('nameVmAttacker2')]"
                    },
                    "Region": {
                        "value": "[resourceGroup().location]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('AdminUsername')]"
                    },
                    "AdminPassword": {
                        "value": "[parameters('AdminPassword')]"
                    },
                    "VmSize": {
                        "value": "[parameters('VmSize')]"
                    },
                    "VnetName": {
                        "value": "[variables('nameVnet')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "[variables('nameDeploymentVmVictim2')]",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('urlTemplates'), '/vm/windows-2012R2.json')]"
                },
                "parameters": {
                    "Name": {
                        "value": "[variables('nameVmVictim2')]"
                    },
                    "Region": {
                        "value": "[resourceGroup().location]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('AdminUsername')]"
                    },
                    "AdminPassword": {
                        "value": "[parameters('AdminPassword')]"
                    },
                    "VmSize": {
                        "value": "[parameters('VmSize')]"
                    },
                    "VnetName": {
                        "value": "[variables('nameVnet')]"
                    }
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', variables('nameDeploymentVmAttacker2'))]"
            ]
        },
        {
            "name": "[concat('shutdown-computevm-', variables('nameVmAttacker'), copyIndex(1))]",
            "type": "Microsoft.DevTestLab/schedules",
            "apiVersion": "2017-04-26-preview",
            "location": "[resourceGroup().location]",
            "copy": {
                "name": "copyShutdownVmAttacker",
                "count": 2
            },
            "properties": {
                "status": "[if(equals(parameters('VmAutoShutdown'), 'true'), 'Enabled', 'Disabled')]",
                "taskType": "ComputeVmShutdownTask",
                "dailyRecurrence": {
                    "time": "19:00"
                },
                "timeZoneId": "Central European Standard Time",
                "targetResourceId": "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('nameVmAttacker'), copyIndex(1)))]",
                "notificationSettings": {
                    "status": "Disabled",
                    "timeInMinutes": "30"
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', variables('nameDeploymentVmAttacker'), copyIndex(1))]"
            ]
        },
        {
            "name": "[concat('shutdown-computevm-', variables('nameVmVictim'), copyIndex(1))]",
            "type": "Microsoft.DevTestLab/schedules",
            "apiVersion": "2017-04-26-preview",
            "location": "[resourceGroup().location]",
            "copy": {
                "name": "copyShutdownVmAttacker",
                "count": 2
            },
            "properties": {
                "status": "[if(equals(parameters('VmAutoShutdown'), 'true'), 'Enabled', 'Disabled')]",
                "taskType": "ComputeVmShutdownTask",
                "dailyRecurrence": {
                    "time": "19:00"
                },
                "timeZoneId": "Central European Standard Time",
                "targetResourceId": "[resourceId('Microsoft.Compute/virtualMachines', concat(variables('nameVmVictim'), copyIndex(1)))]",
                "notificationSettings": {
                    "status": "Disabled",
                    "timeInMinutes": "30"
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', variables('nameDeploymentVmVictim'), copyIndex(1))]"
            ]
        },
        {
            "name": "[concat(variables('nameVmVictim1'), '/CustomScriptForLinux')]",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "location": "[resourceGroup().location]",
            "apiVersion": "2018-10-01",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments/', variables('nameDeploymentVmVictim1'))]"
            ],
            "properties": {
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "fileUris": [
                        "[variables('urlCustomScriptVictim')]"
                    ]
                },
                "publisher": "Microsoft.OSTCExtensions",
                "type": "CustomScriptForLinux",
                "typeHandlerVersion": "1.4",
                "protectedSettings": {
                    "commandToExecute": "sh cs-victim.sh"
                }
            }
        },
        {
            "name": "[concat(variables('nameVmAttacker2'), '/dsc')]",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "location": "[resourceGroup().location]",
            "apiVersion": "2015-06-15",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', variables('nameDeploymentVmAttacker2'))]"
            ],
            "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.77",
                "autoUpgradeMinorVersion": true,
                "forceUpdateTag": "[parameters('DscConfigurationVersion')]",
                "settings": {
                    "configuration": {
                        "url": "[variables('urlDsc')]",
                        "script": "DCE.ps1",
                        "function": "Attacker"
                    },
                    "configurationArguments": {
                        "UrlAssets": "[variables('urlSamples')]"
                    }
                }
            }
        },
        {
            "name": "[concat(variables('nameVmVictim2'), '/dsc')]",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "location": "[resourceGroup().location]",
            "apiVersion": "2015-06-15",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', variables('nameDeploymentVmVictim2'))]"
            ],
            "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.77",
                "autoUpgradeMinorVersion": true,
                "forceUpdateTag": "[parameters('DscConfigurationVersion')]",
                "settings": {
                    "configuration": {
                        "url": "[variables('urlDsc')]",
                        "script": "DCE.ps1",
                        "function": "Victim"
                    },
                    "configurationArguments": {
                        "UrlAssets": "[variables('urlSamples')]"
                    }
                }
            }
        },
        {
            "name": "[concat(variables('nameVmVictim1'), '/OmsAgentForLinux')]",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2015-06-15",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', variables('nameDeploymentVmVictim1'))]"
            ],
            "properties": {
                "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                "type": "OmsAgentForLinux",
                "typeHandlerVersion": "1.8",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "workspaceId": "[reference(variables('idWorkspace'), '2015-03-20').customerId]"
                },
                "protectedSettings": {
                    "workspaceKey": "[listKeys(variables('idWorkspace'), '2015-03-20').primarySharedKey]"
                }
            }
        },
        {
            "name": "[concat(variables('nameVmAttacker2'), '/MMA')]",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2015-06-15",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', variables('nameDeploymentVmAttacker2'))]"
            ],
            "properties": {
                "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                "type": "MicrosoftMonitoringAgent",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "workspaceId": "[reference(variables('idWorkspace'), '2015-03-20').customerId]"
                },
                "protectedSettings": {
                    "workspaceKey": "[listKeys(variables('idWorkspace'), '2015-03-20').primarySharedKey]"
                }
            }
        },
        {
            "name": "[concat(variables('nameVmVictim2'), '/MMA')]",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2015-06-15",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', variables('nameDeploymentVmVictim2'))]"
            ],
            "properties": {
                "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                "type": "MicrosoftMonitoringAgent",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "workspaceId": "[reference(variables('idWorkspace'), '2015-03-20').customerId]"
                },
                "protectedSettings": {
                    "workspaceKey": "[listKeys(variables('idWorkspace'), '2015-03-20').primarySharedKey]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "[variables('nameDeploymentLogicApp')]",
            "apiVersion": "2017-05-10",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('urlSamples'), '/logicapp.json')]"
                },
                "parameters": {
                    "Office365Account": {
                        "value": "[parameters('Office365Account')]"
                    },
                    "MailAddress": {
                        "value": "[parameters('MailAddress')]"
                    }
                }
            }
        }
    ],
    "outputs": {
    }
}
